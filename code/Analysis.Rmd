---
title: "Descriptive Analysis"
author: "Ebba Mark"
date: "`r Sys.Date()`"
output: html_document
---

# Overview 

The following document provides an initial descriptive analysis and data coverage overview of the [[Annual Survey of State and Local Government Finances](https://www.census.gov/programs-surveys/gov-finances.html). The data is provided in a standardised format from [Willamette University](https://willamette.edu/mba/research-impact/public-datasets/index.html). The data is available at a county level between 1970 - 2020 with improved coverage in more recent years. The data has been cleaned and grouped into 17 expenditure categories (listed in data tree below), 4 higher-level categories (comprised of the 17 lower-level categories), and as a county-level total expenditure. All plots are presented using the raw data, whereas the tables presenting the linear time trend results include results for both the raw data and linearly interpolated data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(here)
library(tidyverse)
library(janitor)
library(gridExtra)
library(readr)
library(data.table)
library(usmap)
library(viridis)
library(gifski)
library(gganimate)
library(transformr)
library(fixest)
library(gtools)
library(kableExtra)
library(zoo)
library(tidycensus)
library(data.tree)
library(DiagrammeR)
library(gstat)
library(readxl)
library(plm)

```

```{r functions}
data(fips_codes)
getstate <- fips_codes$state
names(getstate) <- fips_codes$state_code


tem <- data.frame(state.x77)               # Transform matrix into data frame
sta <- cbind(state.abb, tem, state.region) # Combine the three data sets
colnames(sta)[1] <- "State"                # Rename first column
colnames(sta)[10] <- "Region"              # Rename the 10th column
getregion <- sta$Region
names(getregion) <- sta$State

bea_fips <- read_excel(here("data/out/FIPSModificationsVA.xlsx"), skip = 1, col_types = c("text", "text","text","text"))
getfips <- bea_fips$`BEA FIPS`
names(getfips) <- bea_fips$FIPS

```

```{r, message = FALSE, echo = FALSE, include = FALSE}
dfi <- readRDS(here("data/temp/pubexp_1970_2020.RDS")) %>% 
  mutate(fips = ifelse(fips %in% names(getfips), unname(getfips[fips]), fips))

controls <- readRDS(here("data/temp/cainc30_controls.rds"))

map_cats <- unique(dfi$sum_category) 

cats_clean <- lapply(map_cats, function(x) tolower(gsub("__", "_", gsub(",|&", "", gsub(" ", "_", x)))))

# Expenditure categories data: Raw data
temp <- dfi %>% 
  rename(tot = amount) %>% 
  mutate(pc = tot/pop) %>% 
  pivot_wider(names_from = sum_category, values_from = c(tot, pc), names_glue = "{sum_category}_{.value}") %>% 
  select(-Population) %>% 
  clean_names

temp %>% summarise(across(8:41, ~sum(is.na(.x))))

# Expenditure categories data: Linearly Interpolated Data
inter_temp <- temp %>%
  group_by(fips) %>%
  fill(fips_state, .direction = "downup") %>% #arrange(fips) %>% print(n = 21)
  mutate(across(where(is.numeric), ~ ifelse(!(all(is.na(.) | . == 0)) & . == 0, NA, .))) %>%
  mutate(across(where(is.numeric), ~na.approx(., rule = 2))) %>%
  ungroup

temp %>% summarise(across(everything(), ~sum(is.na(.x))))
# 70% complete cases
temp %>% filter(complete.cases(.)) %>% nrow(.)/nrow(temp)

inter_temp %>% summarise(across(8:41, ~sum(is.na(.x))))
inter_temp %>% filter(complete.cases(.)) %>% nrow(.)/nrow(inter_temp)

# Broad expenditure categories data
temp_dfi <- dfi %>% 
  mutate(broad_cat = case_when(sum_category %in% c("Air Transportation",
                                                   "Port Facilities",
                                                   "Liquor Stores") ~ "Commercial",
                               sum_category %in% c("Education", 
                                                   "Housing & Community Development",
                                                   "Fire Protection",      
                                                   "Health & Hospitals",
                                                   "Public Services & Facilities",
                                                   "Public Welfare", 
                                                   "Public Transit",
                                                   "Retirement") ~ "Public Welfare, Services & Facilities",
                               sum_category %in% c("General Administration",     
                                                   "Interest on Debt", 
                                                   "NEC") ~ "Administration & Misc.",
                               sum_category %in% c("Highways",                  
                                                   "Protective Inspection & Regulation",
                                                   "Waste Management & Sewerage",
                                                   "Utilities",
                                                   "Police, Corrections & Judicial") ~ "Infrastructure, Utilities & Regulation"),
         state = getstate[fips_state],
         region = getregion[state])

# Total Expenditure data: Raw
tots <- readRDS(here("data/temp/pubexp_1970_2020_totals.RDS")) %>% 
  mutate(fips = ifelse(fips %in% names(getfips), unname(getfips[fips]), fips)) %>% 
  filter(will_category == "total direct expenditure") %>% 
  group_by(fips) %>%
  fill(fips_state, .direction = "downup") %>% 
  ungroup %>% 
  mutate(state = getstate[fips_state],
         region = getregion[state],
         amount_pc = amount/pop) %>% 
    left_join(., controls, by = c('fips', 'year'))

tots %>% summarise(across(everything(), ~sum(is.na(.x))))
# 70% complete cases
tots %>% filter(complete.cases(.)) %>% nrow(.)/nrow(temp)
tots %>% select(fips, year, amount) %>% filter(!complete.cases(.)) %>% pull(year) %>% unique

# Total Expenditure data: Linearly interpolated
inter_tots <- tots %>% 
  group_by(fips) %>%
  # group_by(fips, fips_state) %>% select(fips, fips_state) %>% ungroup %>% mutate(test = substr(fips, 1,2) != fips_state) %>%  summarise(sum(test))
  mutate(across(where(is.numeric), ~ ifelse(!(all(is.na(.) | . == 0)) & . == 0, NA, .))) %>%
  mutate(across(where(is.numeric), ~ na.approx(., rule = 2))) %>%
  ungroup

```

# Expenditure categories

The data is currently structured in county-year pairs with observations for 17 public expenditure categories. I have manually grouped these 17 categories into 4 higher categories (that can be changed/redefined easily!). The tree structure below displays all categories and groupings. As currently thought out, any or a combination of these categories will serve as outcome/dependent variables.

```{r}

temp_short <- temp_dfi %>% 
  select(broad_cat, sum_category) %>% 
  distinct
temp_short$pathString <- paste("Total Public Expenditure", temp_short$broad_cat, temp_short$sum_category, sep = "/")
tree <- as.Node(temp_short)
print(tree)

```

```{r, eval = FALSE, include = FALSE}
# Plotting functions and files
anim_map <- function(df, cat){
 p <- df %>% 
    filter(year %in% seq(2002,2012,5) & sum_category == cat) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Purples", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0(cat, " - Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year)
 return(p)
}

for(el in map_cats){
  anim_map(dfi, el) %>% anim_save(here(paste0("output/natl_gifs/natl_", gsub("&|,| ", "_", el), ".gif")), .)
}



```

```{r, eval = FALSE, include = FALSE}
# PA (42), TX (48), WV (54), WY (56)
extr_ct <- dfi %>% 
  filter(fips_state %in% c(42, 48, 54, 56)) %>% 
  mutate(state_abb = case_when(fips_state == 42 ~ "PA",
                               fips_state == 48 ~ "TX",
                               fips_state == 54 ~ "WV",
                               fips_state == 56 ~ "WY"),
         state = case_when(fips_state == 42 ~ "Pennsylvania",
                               fips_state == 48 ~ "Texas",
                               fips_state == 54 ~ "West Virginia",
                               fips_state == 56 ~ "Wyoming")) %>% 
  ungroup
```

```{r, eval = FALSE, include = FALSE}

anim_state <- function(df, st, cat){
 p2 <- df %>% 
    filter(year %in% seq(2002,2012,5) & sum_category == cat & state == st) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, include = c(st)) + 
      scale_fill_distiller(palette = "Purples", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0(cat, " - Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year)
 return(p2)
}

for(el in unique(extr_ct$large_category)[39:43]){
  print(el)
  if(extr_ct %>% filter(state == "Wyoming" & large_category == el) %>% pull(amount_pc) %>% sum < 0.01){print(paste0(el, "failed"))
    next
    }else{
  anim_state(extr_ct, "Wyoming", el) %>% anim_save(here(paste0("output/state_gifs/WY_", gsub(" ", "_", gsub("[()]", "", el)), ".gif")), .)}
}
```

```{r, eval = FALSE, include = FALSE}

extr_ct %>% 
  group_by(state, year, sum_category) %>% 
  summarise(amount = sum(amount)) %>% 
  ggplot(., aes(x = year, y = amount, fill = sum_category)) + 
    geom_area() +
  facet_wrap(~state, scales = "free") +
  labs(x = "State", y = "Expenditure") +
  theme(legend.position = "bottom")


# By state
extr_ct %>% 
  group_by(state, year, sum_category) %>% 
  summarise(amount = sum(amount)) %>% 
  ggplot(., aes(x = year, y = amount, fill = sum_category), colour="black") + 
  geom_bar(position="fill", stat="identity") +
    coord_flip() +
  labs(x = "Year", y = "Share of Expenditure", title = "Share of State-level Expenditure per Major Category") +
  theme(legend.position = "bottom", axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.title = element_blank()) + 
  facet_wrap(~state, scales = "free")


```

```{r, eval = FALSE, include = FALSE}

anim_natl <- function(df, cat){
 p <- df %>% 
   filter(year %in% seq(2002,2020,5) & broad_cat == cat) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Purples", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0(cat, " - Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year)
 return(p)
}

for(sec in unique(temp_dfi$broad_cat)){
  print(sec)
  temp_dfi %>%
  group_by(year, broad_cat, fips) %>%
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>%
  ungroup %>%
  mutate(amount_pc = amount/population) %>%
    anim_natl(., sec) %>% 
     anim_save(here(paste0("output/mark/natl_counties_", gsub(" ", "_", gsub(",|&", "", sec)), ".gif")), .)
}

gif_tot <- tots %>%
  mutate(amount_pc = amount/pop) %>% 
  filter(year %in% seq(2002,2020,5)) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Greens", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0("Total Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year) 

anim_save(here(paste0("output/mark/natl_counties_total_expenditure.gif")), gif_tot)

```

# Overview Plots

The below plots provide aggregated geographical (national, state, regional) summaries of expenditure categories and shares to demonstrate the composition of national expenditure across the categories. The final two plots demonstrate the composition of expenditure within the Public Welfare, Services & Facilities category.

```{r, warning=FALSE, message = FALSE}

# Total as recorded by region
p1 <- tots %>% 
  group_by(year, region) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = region)) +
  geom_area() +
  labs(x = "Year", y = "Expenditure per capita", title = "Total Direct Expenditure per Capita by Region") +
  theme(legend.position = "bottom") + guides(fill=guide_legend(ncol =1))
  

```

```{r, warning=FALSE, message = FALSE, fig.height = 8, fig.width = 8}

# National Expenditure per category (as calculated from expenditure categories)
p3 <- dfi %>% 
  group_by(year, sum_category) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = sum_category)) +
  geom_area() +
  labs(x = "Year", y = "Expenditure per capita (thousands)", title = "National Expenditure per Category") +
  theme(legend.position = "bottom")

# TOTAL expenditure as calculated from our low-level categories
p4 <- dfi %>% 
  mutate(state = getstate[fips_state],
         region = getregion[state]) %>%
  group_by(year, region) %>% 
  summarise(amount = sum(amount, na.rm = TRUE)) %>% 
  # NOT PER CAPITA VALUES
  ggplot(aes(x = year, y = amount, fill = region)) +
  geom_area() +
  labs(x = "Year", y = "Expenditure (thousands)", title = "National Expenditure per Region (as calculated from expenditure categories)") +
  theme(legend.position = "bottom")



p5a <- temp_dfi %>% 
  group_by(year, broad_cat) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = broad_cat)) +
  geom_area() +
  scale_fill_brewer(name = "Expenditure Category", palette = "Paired") +
  labs(x = "Year", y = "Expenditure per capita (thousands)", title = "National Expenditure per Broad Category") + 
  theme(legend.position = "none", plot.title = element_text(size=10))

p5b <- temp_dfi %>% 
  group_by(year, broad_cat) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount, fill = broad_cat)) +
  geom_area(position="fill", stat="identity") +
  scale_fill_brewer(name = "Expenditure Category", palette = "Paired") +
  labs(x = "Year", y = "Expenditure (share)", title = "National Share of Expenditure per Broad Category") +
  theme(legend.position = "bottom", legend.key.size = unit(0.5, 'cm'), plot.title = element_text(size=10)) + guides(fill=guide_legend(ncol = 2, title.position = "top"))

lev_order <- temp_dfi %>% 
  arrange(broad_cat) %>% 
  mutate(as.factor(sum_category)) %>% 
  pull(sum_category) %>% 
  unique

p5c <- temp_dfi %>% 
  group_by(year, sum_category, broad_cat) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  arrange(broad_cat) %>% 
  mutate(sum_category = factor(sum_category, levels = lev_order)) %>%
  ggplot(aes(x = year, y = amount_pc, fill = sum_category)) +
  geom_area(position="fill", stat="identity") +
  facet_grid(broad_cat~., scales = "free") + 
  scale_fill_viridis(name = "Exp. Cat.", option = "turbo", discrete = TRUE) +
  labs(x = "Year", y = "Share of Expenditure", title = "Composition of Broad National Expenditure Categories") +
  theme(legend.position = "bottom", legend.key.size = unit(0.2, 'cm'), plot.title = element_text(size=9), strip.text.y = element_text(size = 6)) + guides(fill=guide_legend(ncol =2, title.position = "top"))

p6 <- temp_dfi %>% 
  filter(broad_cat == "Public Welfare, Services & Facilities") %>% 
  group_by(year, sum_category, region) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  ggplot(aes(x = year, y = amount, fill = sum_category)) +
  geom_area(position="fill", stat="identity") +
  scale_fill_brewer(name = "Expenditure Category", palette = "Spectral")+
  facet_wrap(~region, scales = "free") +
  labs(x = "Year", y = "Share of expenditure", title = "Share of Total 'Public Welfare, Services & Facilities' Expenditure by Category and Region") +
  theme(legend.position = "bottom", axis.text.y = element_blank())


# Pull top 5 energy producing states (55% of national energy production)
p7 <- temp_dfi %>% 
  filter(state %in% c("TX", "PA", "WY", "OK", "WV", "ND")) %>% 
    filter(broad_cat == "Public Welfare, Services & Facilities") %>% 
  group_by(year, sum_category, state) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = sum_category)) +
  geom_area(position="fill", stat="identity") +
  scale_fill_brewer(name = "Expenditure Category", palette = "Spectral") +
  facet_wrap(~state, scales = "free") +
  labs(x = "Year", y = "Share of expenditure", title = "Share of 'Public Welfare, Services & Facilities' Expenditure by Cat. in Top Energy Producing States") +
  theme(legend.position = "bottom", axis.text.y = element_blank())
    

grid.arrange(grid.arrange(p5a, p5b, nrow = 2), p5c, nrow = 1)
p6
p7


```

# Data Coverage
## Time - Missing Data
```{r, message = FALSE, echo = FALSE}
# Max possible values in each year is : 58102
n_distinct(temp_dfi$fips) * n_distinct(temp_dfi$sum_category)

# Major conclusion about missing values: only due to non-reporting!
miss_vals <- temp_dfi %>% select(fips, year, sum_category, amount) %>% filter(is.na(amount))
cats <- unique(miss_vals$sum_category)
d.list <- list()
for(ck in cats){
  d.list[[ck]] <- miss_vals %>% filter(sum_category == ck) %>% select(-sum_category)
}
length(unique(d.list)) == 1

# Histogram of missing values overall: code only works because of above fact
hist_time <- temp_dfi %>% 
  group_by(fips, year) %>% 
  summarise(amount = sum(amount)) %>% 
  ungroup %>% 
  filter(is.na(amount)) %>% 
  ggplot() + 
  geom_histogram(aes(year), bins = 51) +
  geom_hline(aes(yintercept = n_distinct(temp_dfi$fips))) +
  labs(title = "Missing values across full TS", subtitle = "Horizontal line represents total number of counties", y = "Number of counties not reporting", x = "Year")

counties <- temp_dfi %>% 
  group_by(fips, year) %>% 
  summarise(amount = sum(amount)) %>% 
  ungroup %>% 
  group_by(fips) %>% 
  summarise(nna = sum(is.na(amount)),
            prop_missing = nna/51) %>% 
  ungroup %>% 
  plot_usmap(data = ., values = "prop_missing", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Purples", name = "Proportion", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0("Proportion of TS Missing"))

states <- plot_usmap(include = c("TX", "PA", "OK", "WY", "WV", "ND", "NV", "NM", "LA", "CO"))

missing_spat <- ggplot() +  
  geom_polygon(data=counties[[1]], 
               aes(x=x, 
                   y=y, 
                   group=group, 
                   fill = prop_missing), 
               color = "black",
               size = 0.01) +  
  geom_polygon(data=states[[1]], 
               aes(x=x, 
                   y=y, 
                   group=group), 
               color = "red", 
               fill = alpha(0.01)) + 
  coord_equal() +
  scale_fill_gradient(low='white', high='grey20')+
  labs(y = NULL, x = NULL, title = "Proportion of missing TS by county", subtitle = "Top fossil-fuel producing states outlined in red") +
   theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank(),
      axis.text.x=element_blank(), 
      axis.ticks.x=element_blank(), 
      axis.text.y=element_blank(), 
      axis.ticks.y=element_blank())

grid.arrange(hist_time, missing_spat, ncol = 1)

```


# Analysis of Time Trends

The following tables provide standard linear time trends evaluated in a county-fixed effects panel linear regression model for a panel of 3,037 counties and for a time period of 2001-2020. \
*Dependent variables*: Expenditure by category per capita values. \
*Data*: Raw data and linearly interpolated data.

*Result*: Expenditure levels increase (as seen in overview graphs) but per capita expenditure remains stationary.

## Broad (4) and Total Expenditure Categories

```{r, echo = FALSE, message = FALSE, results = 'asis'}

create_res <- function(df, cats, regx, suffix){
  res <- tibble()
  for(j in cats){
    form <- as.formula(paste0(j, '*1000', regx))
    test <- feols(fml = form, data = df, panel.id = c('year', 'fips'), cluster = "fips")
    test <- test$coeftable %>% as.tibble
    test$outcome_var <- j
    res <- rbind(res, test)
  }
  
  tbl <- res %>% 
        mutate(sig = stars.pval(`Pr(>|t|)`),
        outcome_var = str_to_title(gsub("_", " ", gsub(suffix, "", outcome_var)))) %>% 
        relocate(outcome_var) %>% 
        select(-`Pr(>|t|)`) %>% 
        arrange(Estimate) %>% 
    mutate(Estimate = paste0(round(Estimate, 2), sig), `Std. Error` = as.character(round(`Std. Error`, 2))) %>% 
    select(-c(`t value`, sig)) %>% 
    pivot_longer(!outcome_var, values_to = "Estimate", names_to = "_")
    
    return(list("res" = res, "tbl" = tbl))
}


broad_df <- temp_dfi %>% 
  group_by(year, broad_cat, fips) %>%
  mutate(amount = sum(amount, na.rm = TRUE),
         population = sum(pop, na.rm = TRUE)) %>%
  ungroup %>% 
  select(-sum_category) %>% 
  distinct %>% 
  mutate(amount_pc = amount/population) %>% 
  complete(fips, year, broad_cat) %>% 
  rename(tot = amount, pc = amount_pc) %>%
  pivot_wider(id_cols = c(fips, year), names_from = broad_cat, values_from = c(tot, pc), names_glue = "{broad_cat}_{.value}") %>% 
  clean_names %>% arrange(fips, year) %>% 
  left_join(., controls, by = c('fips', 'year')) %>% 
  mutate(time = year - 1970, 
         state = getstate[substr(fips, 1,2)],
         region = getregion[state])
  

broad_df_inter <- broad_df %>% 
  group_by(fips) %>%
  mutate(across(where(is.numeric), ~ ifelse(!(all(is.na(.) | . == 0)) & . == 0, NA, .))) %>%
  mutate(across(where(is.numeric), ~na.approx(., rule = 2))) %>%
  ungroup

broad_cats <- names(select(broad_df, -c(fips, year)))
broad_df %>% summarise(across(3:10, ~sum(is.na(.x))))
broad_df_inter %>% summarise(across(3:10, ~sum(is.na(.x))))

# Time trends: PC expenditure with and without interpolated data
time_broad_raw_pc <- create_res(df = broad_df, cats = broad_cats[grepl("pc", broad_cats)], regx = " ~ time | fips", suffix = "_pc")
time_broad_inter_pc <- create_res(df = broad_df_inter, cats = broad_cats[grepl("pc", broad_cats)], regx = " ~ time | fips", suffix = "_pc")

tk <- full_join(time_broad_raw_pc$tbl, time_broad_inter_pc$tbl, by = c("outcome_var", "_"), suffix = c(".time_raw_pc", ".time_inter_pc")) %>% 
  select(-`_`) %>% 
  group_by(outcome_var) %>%
    mutate(outcome_var = ifelse(duplicated(outcome_var), '', outcome_var)) %>% 
  knitr::kable(., booktabs = TRUE, col.names = c("Outcome Variable", "w. Raw Data", "w. Lin. Interpol."), align = c("l","c","c"), format = "html") %>% 
  add_header_above(c(" ", "Expenditure PC" = 2))

knitr::asis_output(tk)


```


## Across Granular Expenditure Categories (17)

```{r, echo = FALSE, message = FALSE, results = 'asis'}
# Time trends: Total expenditure with and without interpolated data
time_raw <- create_res(df = temp, cats = paste0(cats_clean, "_tot"), regx = " ~ time | fips", suffix = "_tot")
time_inter <- create_res(df = inter_temp, cats = paste0(cats_clean, "_tot"), regx = " ~ time | fips", suffix = "_tot")

# Time trends: PC expenditure with and without interpolated data
time_raw_pc <- create_res(df = temp, cats = paste0(cats_clean, "_pc"), regx = " ~ time | fips", suffix = "_pc")
time_inter_pc <- create_res(df = inter_temp, cats = paste0(cats_clean, "_pc"), regx = " ~ time | fips", suffix = "_pc")

tj <- full_join(time_raw$tbl,
          time_inter$tbl, by = c("outcome_var", "_"), suffix = c(".time_raw", "")) %>% 
  full_join(., time_raw_pc$tbl, by = c("outcome_var", "_"), suffix = c(".time_inter", "")) %>% 
          full_join(., time_inter_pc$tbl, by = c("outcome_var", "_"), suffix = c(".time_raw_pc", ".time_inter_pc")) %>% 
  select(-`_`) %>% 
  group_by(outcome_var) %>%
    mutate(outcome_var = ifelse(duplicated(outcome_var), '', outcome_var)) %>% 
  knitr::kable(., booktabs = TRUE, col.names = c("Outcome Variable", "w. Raw Data", "w. Lin. Interpol.", "w. Raw Data", "w. Lin. Interpol."), align = c("l","c","c","c","c"), format = "html") %>% 
  add_header_above(c(" ", "Expenditure (levels)" = 2, "Expenditure (per capita)" = 2))

knitr::asis_output(tj)
```


```{r, echo = FALSE, message = FALSE, results = 'asis'}
# # Totals
# # Time trends: Total expenditure with and without interpolated data
# time_tots_raw <- create_res(df = tots, cats = "amount", regx = " ~ year | fips", suffix = "")
# time_tots_inter <- create_res(df = inter_tots, cats = "amount", regx = " ~ year | fips", suffix = "")
# 
# # Time trends: PC expenditure with and without interpolated data
# time_tots_raw_pc <- create_res(df = tots, cats = "amount_pc", regx = " ~ year | fips", suffix = "")
# time_tots_inter_pc <- create_res(df = inter_tots, cats = "amount_pc", regx = " ~ year | fips", suffix = "")
# 
# tt <- full_join(time_tots_raw$tbl,
#           time_tots_inter$tbl, by = c("outcome_var", "_"), suffix = c(".time_raw", "")) %>% 
#   full_join(., time_tots_raw_pc$tbl, by = c("outcome_var", "_"), suffix = c(".time_inter", "")) %>% 
#           full_join(., time_tots_inter_pc$tbl, by = c("outcome_var", "_"), suffix = c(".time_raw_pc", ".time_inter_pc")) %>% 
#   select(-`_`) %>% 
#   group_by(outcome_var) %>%
#     mutate(outcome_var = ifelse(duplicated(outcome_var), '', outcome_var)) %>% 
#   knitr::kable(., booktabs = TRUE, col.names = c("Outcome Variable", "w. Raw Data", "w. Lin. Interpol.", "w. Raw Data", "w. Lin. Interpol."), align = c("l","c","c","c","c"), format = "html") %>% 
#   add_header_above(c(" ", "Expenditure (levels)" = 2, "Expenditure (per capita)" = 2))
# 
# knitr::asis_output(tt)

```

# Preliminary Analysis
## Time Trends
```{r}

deps = paste0(broad_cats[grepl("pc", broad_cats)], "*1000")

# With the county-fixed effects you get an estimate that corrects for unit specific intercepts
time_fe <- feols(data = broad_df, .[deps] ~ time | fips, panel.id = c('year', 'fips'), cluster = "fips")

# AR with county-fixed effects
ar <- feols(data = broad_df, public_welfare_services_facilities_pc*1000 ~ time + l(public_welfare_services_facilities_pc) | fips, panel.id = c('year', 'fips'), cluster = "fips")

ar_twfe <- feols(data = broad_df, public_welfare_services_facilities_pc*1000 ~ l(public_welfare_services_facilities_pc) | fips + year, panel.id = c('year', 'fips'), se = "twoway")

broad_df_inter_long <- broad_df_inter %>% 
  select(fips, year, administration_misc_pc, 
         commercial_pc, infrastructure_utilities_regulation_pc, 
         public_welfare_services_facilities_pc) %>% 
  pivot_longer(cols = !c(fips, year))
# 
# deps = broad_cats[grepl("pc", broad_cats)]
# plist <- list()
# for(k in deps[1:4]){
#   plist[[k]] = broad_df_inter_long %>% 
#   filter(name == k) %>% 
#   group_by(year) %>%
#   summarise(mean = log(mean(value, na.rm = TRUE)),
#             upp_quart = log(quantile(value, probs = c(0.75), na.rm = TRUE)),
#             low_quart = log(quantile(value, probs = c(0.25), na.rm = TRUE))) %>%
#   left_join(broad_df_inter_long) %>%
#   ggplot(data = ., 
#          aes(x = year, y = log(value + 1))) +
#   geom_point() +
#   geom_line(aes(x = year, y = mean), col = "green") +
#   geom_line(aes(x = year, y = upp_quart), col = "blue") +
#   geom_line(aes(x = year, y = low_quart), col = "red") +
#   scale_x_continuous(labels = as.character(broad_df_inter_long$year), 
#                      breaks = broad_df_inter_long$year) +
#   labs(x = "Year", y = k) +
#   theme(axis.text.x = element_text(angle = 90))
# }
# 
# do.call(grid.arrange, c(plist, ncol = 2))

# Entity heterogeneity
# broad_df %>%
#   group_by(year) %>%
#   summarise(pub_mean = log(mean(public_welfare_services_facilities_pc, na.rm = TRUE)*1000)) %>%
#   left_join(broad_df) %>%
#   ggplot(data = ., 
#          aes(x = year, y = log(public_welfare_services_facilities_pc*1000))) +
#   geom_point() +
#   geom_line(aes(x = year, y = pub_mean), col = "blue") +
#   scale_x_continuous(labels = as.character(broad_df$year), 
#                      breaks = broad_df$year) +
#   labs(x = "Year", y = "Public Welfare, Services, Facilities") +
#   theme(axis.text.x = element_text(angle = 90))

```

### Common Time Trends
```{r}

deps = broad_cats[grepl("pc", broad_cats)]
ldeps = paste0(" ~ l(", deps, ")")
forms = paste0(deps, paste0(" ~ l(", deps, ")"))

# Expenditure across broad categories
broad_plms <- feols(data = broad_df, .[deps] ~ time - 1, panel.id = c('year', 'fips'), se = "twoway")
broad_plms_inter <- feols(data = broad_df_inter, .[deps]  ~ pinc_k_pc | fips + year, panel.id = c('year', 'fips'), se = "twoway")

feols(data = broad_df, administration_misc_pc  ~ l(administration_misc_pc) | fips , panel.id = c('year', 'fips'), se = "twoway")


# Total expenditure
tot_mod_pc <- feols(data = tots, amount_pc ~ pinc_k_pc | fips + year, panel.id = c('year', 'fips'), se = "twoway")
tot_inter_pc <- create_res(df = inter_tots, amount_pc ~ pinc_k_pc | fips + year, panel.id = c('year', 'fips'), se = "twoway")


```


### Heterogeneous Time Trends
```{r}

```


## Factor Analysis

## Spatial Analysis
```{r}

# Sample code from coal paper
library(gstat)
# Using coordinate data
county_coord <- read.csv(here("data/us-county-boundaries.csv"), sep = ";") %>% select(GEOID, INTPTLAT, INTPTLON) %>% tibble %>% mutate(GEOID = ifelse(nchar(GEOID) == 4, paste0("0", as.character(GEOID)), as.character(GEOID))) %>% rename(fips = GEOID) %>% filter(fips %in% allcomp_full$fips) %>% right_join(select(allcomp_full, year, diff_uer, fips), by = "fips") %>% filter(!is.na(INTPTLAT))
                         
#coordinates(county_coord) = ~INTPTLON+INTPTLAT
spat_dep <- tibble(year = character(),
                   gamma = numeric(),
                   dist = numeric())
for(i in 2002:2019){
  t <- filter(county_coord, year == i)
  coordinates(t) = ~INTPTLON+INTPTLAT
  test <- variogram(diff_uer ~ 1, locations = coordinates(t), data = t, cutoff = 10)
  spat_dep <- rbind(spat_dep, tibble(year = i,
                                     gamma = test$gamma,
                                     dist = test$dist))
}

library(ggrepel)
full_spat <- spat_dep %>% mutate(year = as.factor(year)) %>% group_by(year) %>% mutate(label = ifelse(dist == max(dist), as.character(year), NA)) %>% 
ggplot(aes(x = dist, y = gamma, color = year, group = year)) +
  geom_line() +
  geom_label_repel(aes(label = label),
                   nudge_x = 2,
                   na.rm = TRUE,
                   max.overlaps = Inf) +
  theme(legend.position = "none", panel.background = element_blank(), panel.grid.major = element_line(colour = "grey90", linetype = "dashed")) +
  xlab("Distance between counties") +
  ylab("Measure of dissimilarity of outcome variable (UER)")

```




