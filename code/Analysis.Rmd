---
title: "Descriptive Analysis"
author: "Ebba Mark"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
---

# Overview 

The following document provides an initial descriptive analysis and data coverage overview of the [[Annual Survey of State and Local Government Finances](https://www.census.gov/programs-surveys/gov-finances.html). The data is provided in a standardised format from [Willamette University](https://willamette.edu/mba/research-impact/public-datasets/index.html). The data is available at a county level between 1970 - 2020 with improved coverage in more recent years. The data has been cleaned and grouped into 17 expenditure categories (listed in data tree below), 4 higher-level categories (comprised of the 17 lower-level categories), and as a county-level total expenditure. All plots are presented using the raw data, whereas the tables presenting the linear time trend results include results for both the raw data and linearly interpolated data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

library(here)
library(tidyverse)
library(janitor)
library(gridExtra)
library(readr)
library(data.table)
library(usmap)
library(viridis)
library(gifski)
library(gganimate)
library(transformr)
library(fixest)
library(gtools)
library(kableExtra)
library(zoo)
library(tidycensus)
library(data.tree)
library(DiagrammeR)
library(gstat)
library(readxl)
library(plm)
library(modelsummary)
library(pdftools)
library(tinytex)
library(pander)

```

```{r functions}

source(here('code/dicts.R'))

```

# Data
```{r, message = FALSE, echo = FALSE, include = FALSE, cache = TRUE}

################################################################################
############# COMPONENT DATASETS ###############################################
# Main public expenditure dataset
dfi <- readRDS(here("data/temp/pubexp_1970_2020.RDS")) %>% 
  mutate(fips = ifelse(fips %in% names(getfips), unname(getfips[fips]), fips)) %>% 
  filter(!(fips %in% c("46131", "51123")))

# Main public revenue dataset
dfi_rev <- readRDS(here('data/temp/county_rev.RDS')) %>% 
  mutate(fips = ifelse(fips %in% names(getfips), unname(getfips[fips]), fips),
         fips = case_when(fips == "46113" ~ "46102",
                          # Maui is recorded in non-BEA records as fips 15009 + fips 15005. 
                          # 15005 not present in public finance dataset so only 15009 is replaced
                          fips == "15009" ~ "15901",
                          TRUE ~ fips)) %>% 
  filter(!(fips %in% c("46131", "51123"))) %>% 
  pivot_wider(id_cols = c(fips, year, Population), names_from = "item", values_from = "amount") %>% 
  mutate(across(total_revenue:unemp_federal_advances,.fns = ~./Population, .names = "{.col}_pc")) %>% 
  complete(year, fips)

# Control variables
controls <- readRDS(here("data/temp/cainc30_controls.rds")) %>% 
  left_join(readRDS(here("data/temp/gdp_controls.RDS")), by = c("fips", "year")) %>% 
  left_join(readRDS(here("data/temp/econ_div_controls.RDS")), by = c("fips", "year")) %>% 
  filter(!(fips %in% c("46131", "51123")))

# Shift share instruments
shift_shares <- readRDS(here('data/temp/shift_shares_base_01_05_11.RDS')) %>% 
  mutate(fips = ifelse(fips == "15009", "15901", fips))  %>% 
  filter(!(fips %in% c("46131", "51123")))

################################################################################
############# CATEGORIZATION ###################################################

# Expenditure categories data: Raw data
temp <- dfi %>% 
  rename(tot = amount) %>% 
  mutate(pc = tot/pop) %>% 
  pivot_wider(names_from = sum_category, values_from = c(tot, pc), names_glue = "{sum_category}_{.value}") %>% 
  select(-Population) %>% 
  clean_names

# temp %>% summarise(across(8:41, ~sum(is.na(.x))))

# Expenditure categories data: Linearly Interpolated Data
inter_temp <- temp %>%
  group_by(fips) %>%
  fill(fips_state, .direction = "downup") %>% #arrange(fips) %>% print(n = 21)
  mutate(across(where(is.numeric), ~ ifelse(!(all(is.na(.) | . == 0)) & . == 0, NA, .))) %>%
  mutate(across(where(is.numeric), ~na.approx(., rule = 2))) %>%
  ungroup

# temp %>% summarise(across(everything(), ~sum(is.na(.x))))
# # 70% complete cases
# temp %>% filter(complete.cases(.)) %>% nrow(.)/nrow(temp)
# 
# inter_temp %>% summarise(across(8:41, ~sum(is.na(.x))))
# inter_temp %>% filter(complete.cases(.)) %>% nrow(.)/nrow(inter_temp)

# Broad expenditure categories data
temp_dfi <- dfi %>% 
  mutate(broad_cat = case_when(sum_category %in% c("Air Transportation",
                                                   "Port Facilities",
                                                   "Liquor Stores") ~ "Commercial",
                               sum_category %in% c("Education", 
                                                   "Housing & Community Development",
                                                   "Fire Protection",      
                                                   "Health & Hospitals",
                                                   "Public Services & Facilities",
                                                   "Public Welfare", 
                                                   "Public Transit",
                                                   "Retirement") ~ "Public Welfare, Services & Facilities",
                               sum_category %in% c("General Administration",     
                                                   "Interest on Debt", 
                                                   "NEC") ~ "Administration & Misc.",
                               sum_category %in% c("Highways",                  
                                                   "Protective Inspection & Regulation",
                                                   "Waste Management & Sewerage",
                                                   "Utilities",
                                                   "Police, Corrections & Judicial") ~ "Infrastructure, Utilities & Regulation"),
         state = getstate[fips_state],
         region = getregion[state]) %>% 
  filter(!(state %in% c("AK", "HI")))

################################################################################
############# BROAD CATEGORIES #################################################

broad_df <- temp_dfi %>% 
  group_by(year, broad_cat, fips) %>%
  mutate(amount = sum(amount, na.rm = TRUE),
         population = sum(pop, na.rm = TRUE)) %>%
  ungroup %>% 
  select(-sum_category) %>% 
  distinct %>% 
  mutate(amount_pc = amount/population) %>% 
  complete(fips, year, broad_cat) %>% 
  rename(tot = amount, pc = amount_pc) %>%
  pivot_wider(id_cols = c(fips, year), names_from = broad_cat, values_from = c(tot, pc), names_glue = "{broad_cat}_{.value}") %>% 
  clean_names %>% arrange(fips, year) %>% 
  left_join(., controls, by = c('fips', 'year')) %>% 
  mutate(time = year - 1970, 
         state = getstate[substr(fips, 1,2)],
         region = getregion[state]) %>% 
  mutate(across(real_gdp_total:gdp_govt, ~./population_persons, .names = "{col}_pc"))

broad_df_inter <- broad_df %>% 
  group_by(fips) %>%
  mutate(across(where(is.numeric), ~ ifelse(!(all(is.na(.) | . == 0)) & . == 0, NA, .))) %>%
  mutate(across(where(is.numeric), ~na.approx(., rule = 2))) %>%
  ungroup


broad_df_ss <- broad_df_inter %>% 
  filter(year >= 2001) %>% 
  left_join(., shift_shares, by = c("fips", "year"))

################################################################################
############# TOTAL PUBLIC EXPENDITURE #########################################

# Total Expenditure data: Raw
tots <- readRDS(here("data/temp/pubexp_1970_2020_totals.RDS")) %>% 
  mutate(fips = ifelse(fips %in% names(getfips), unname(getfips[fips]), fips)) %>% 
  filter(will_category == "total direct expenditure") %>% 
  group_by(fips) %>%
  fill(fips_state, .direction = "downup") %>% 
  ungroup %>% 
  mutate(state = getstate[fips_state],
         region = getregion[state],
         amount_pc = amount/pop,
         time = year - 1970) %>% 
    left_join(., controls, by = c('fips', 'year')) %>% 
  mutate(across(real_gdp_total:gdp_govt, ~./pop, .names = "{col}_pc")) %>% 
  filter(!(fips %in% c("46131", "51123")))

# tots %>% summarise(across(everything(), ~sum(is.na(.x))))
# # 70% complete cases
# tots %>% filter(complete.cases(.)) %>% nrow(.)/nrow(temp)
# tots %>% select(fips, year, amount) %>% filter(!complete.cases(.)) %>% pull(year) %>% unique

# Total Expenditure data: Linearly interpolated
inter_tots <- tots %>% 
  group_by(fips) %>%
  # group_by(fips, fips_state) %>% select(fips, fips_state) %>% ungroup %>% mutate(test = substr(fips, 1,2) != fips_state) %>%  summarise(sum(test))
  mutate(across(where(is.numeric), ~ ifelse(!(all(is.na(.) | . == 0)) & . == 0, NA, .))) %>%
  mutate(across(where(is.numeric), ~ na.approx(., rule = 2))) %>%
  ungroup

tots_df_ss <- inter_tots %>% 
  filter(year >= 2001) %>% 
  left_join(., shift_shares, by = c("fips", "year"))


################################################################################
############# TOTAL PUBLIC REVENUE #########################################

rev_df <- dfi_rev %>% 
  select(year, fips, contains("total_rev"), contains("tax"), 
         contains("general_revenue"), contains("gen_rev_own_sources"), contains("corporation_license"),
         contains("public_utility_license"), contains("occup_and_bus_lic_nec"),
         contains("total_income_taxes"), contains("interest_revenue"), 
         contains("rents_and_royalties"), contains("liquor_stores_revenue"), 
         contains("total_utility_revenue"), contains("water_utility_revenue"), 
         contains("electric_utility_rev"), contains("gas_utility_rev"), 
         contains("transit_utility_rev"), contains("total_insur_trust_rev"),
         contains("total_unemp_rev"), contains("unemp_payroll_tax"), 
         contains("unemp_int_revenue"), contains("unemp_federal_advances")) %>% 
  left_join(., controls, by = c('fips', 'year')) %>% 
  mutate(across(real_gdp_total:gdp_govt, ~./population_persons, .names = "{col}_pc")) %>% 
  left_join(., shift_shares, by = c('fips', 'year')) %>% 
  mutate(fips_state = substr(fips, 1,2),
         state = getstate[fips_state],
         region = getregion[state]) %>% 
  filter(!(state %in% c("AK", "HI")),
         year >= 2001)

inter_rev <- dfi_rev %>% 
  select(year, fips, contains("total_rev"), contains("tax"), 
         contains("general_revenue"), contains("gen_rev_own_sources"), contains("corporation_license"),
         contains("public_utility_license"), contains("occup_and_bus_lic_nec"),
         contains("total_income_taxes"), contains("interest_revenue"), 
         contains("rents_and_royalties"), contains("liquor_stores_revenue"), 
         contains("total_utility_revenue"), contains("water_utility_revenue"), 
         contains("electric_utility_rev"), contains("gas_utility_rev"), 
         contains("transit_utility_rev"), contains("total_insur_trust_rev"),
         contains("total_unemp_rev"), contains("unemp_payroll_tax"), 
         contains("unemp_int_revenue"), contains("unemp_federal_advances")) %>% 
  group_by(fips) %>% 
  mutate(across(where(is.numeric), ~ ifelse(!(all(is.na(.) | . == 0)) & . == 0, NA, .))) %>%
  mutate(across(where(is.numeric), ~na.approx(., rule = 2))) %>%
  ungroup %>% 
  left_join(., controls, by = c('fips', 'year')) %>% 
  mutate(across(real_gdp_total:gdp_govt, ~./population_persons, .names = "{col}_pc")) %>% 
  left_join(., shift_shares, by = c('fips', 'year')) %>% 
  mutate(fips_state = substr(fips, 1,2),
         state = getstate[fips_state],
         region = getregion[state]) %>% 
  filter(!(state %in% c("AK", "HI")),
         year >= 2001)



######## Clear up environment
rm(shift_shares)
rm(controls)
rm(dfi_rev)
rm(temp)
rm(inter_temp)

```

# Expenditure categories

The data is currently structured in county-year pairs with observations for 17 public expenditure categories. I have manually grouped these 17 categories into 4 higher categories (that can be changed/redefined easily!). The tree structure below displays all categories and groupings. As currently thought out, any or a combination of these categories will serve as outcome/dependent variables.

```{r, cache = TRUE}

temp_short <- temp_dfi %>% 
  select(broad_cat, sum_category) %>% 
  distinct
temp_short$pathString <- paste("Total Public Expenditure", temp_short$broad_cat, temp_short$sum_category, sep = "/")
tree <- as.Node(temp_short)
print(tree)

```

```{r, eval = FALSE, include = FALSE}
# Plotting functions and files
anim_map <- function(df, cat){
 p <- df %>% 
    filter(year %in% seq(2002,2012,5) & sum_category == cat) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Purples", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0(cat, " - Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year)
 return(p)
}

for(el in map_cats){
  anim_map(dfi, el) %>% anim_save(here(paste0("output/natl_gifs/natl_", gsub("&|,| ", "_", el), ".gif")), .)
}



```

```{r, eval = FALSE, include = FALSE}
# PA (42), TX (48), WV (54), WY (56)
extr_ct <- dfi %>% 
  filter(fips_state %in% c(42, 48, 54, 56)) %>% 
  mutate(state_abb = case_when(fips_state == 42 ~ "PA",
                               fips_state == 48 ~ "TX",
                               fips_state == 54 ~ "WV",
                               fips_state == 56 ~ "WY"),
         state = case_when(fips_state == 42 ~ "Pennsylvania",
                               fips_state == 48 ~ "Texas",
                               fips_state == 54 ~ "West Virginia",
                               fips_state == 56 ~ "Wyoming")) %>% 
  ungroup
```

```{r, eval = FALSE, include = FALSE}

anim_state <- function(df, st, cat){
 p2 <- df %>% 
    filter(year %in% seq(2002,2012,5) & sum_category == cat & state == st) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, include = c(st)) + 
      scale_fill_distiller(palette = "Purples", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0(cat, " - Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year)
 return(p2)
}

for(el in unique(extr_ct$large_category)[39:43]){
  print(el)
  if(extr_ct %>% filter(state == "Wyoming" & large_category == el) %>% pull(amount_pc) %>% sum < 0.01){print(paste0(el, "failed"))
    next
    }else{
  anim_state(extr_ct, "Wyoming", el) %>% anim_save(here(paste0("output/state_gifs/WY_", gsub(" ", "_", gsub("[()]", "", el)), ".gif")), .)}
}
```

```{r, eval = FALSE, include = FALSE}

extr_ct %>% 
  group_by(state, year, sum_category) %>% 
  summarise(amount = sum(amount)) %>% 
  ggplot(., aes(x = year, y = amount, fill = sum_category)) + 
    geom_area() +
  facet_wrap(~state, scales = "free") +
  labs(x = "State", y = "Expenditure") +
  theme(legend.position = "bottom")


# By state
extr_ct %>% 
  group_by(state, year, sum_category) %>% 
  summarise(amount = sum(amount)) %>% 
  ggplot(., aes(x = year, y = amount, fill = sum_category), colour="black") + 
  geom_bar(position="fill", stat="identity") +
    coord_flip() +
  labs(x = "Year", y = "Share of Expenditure", title = "Share of State-level Expenditure per Major Category") +
  theme(legend.position = "bottom", axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.title = element_blank()) + 
  facet_wrap(~state, scales = "free")


```

```{r, eval = FALSE, include = FALSE}

anim_natl <- function(df, cat){
 p <- df %>% 
   filter(year %in% seq(2002,2020,5) & broad_cat == cat) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Purples", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0(cat, " - Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year)
 return(p)
}

for(sec in unique(temp_dfi$broad_cat)){
  print(sec)
  temp_dfi %>%
  group_by(year, broad_cat, fips) %>%
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>%
  ungroup %>%
  mutate(amount_pc = amount/population) %>%
    anim_natl(., sec) %>% 
     anim_save(here(paste0("output/mark/natl_counties_", gsub(" ", "_", gsub(",|&", "", sec)), ".gif")), .)
}

gif_tot <- tots %>%
  mutate(amount_pc = amount/pop) %>% 
  filter(year %in% seq(2002,2020,5)) %>% 
    mutate(amount_pc = ifelse(amount_pc == 0, NA, log(amount_pc*1000))) %>% 
    plot_usmap(data = ., values = "amount_pc", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Greens", name = "Log PC Expenditure (Thousands)", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0("Total Expenditure per capita"), subtitle = "Year: {closest_state}") +
    transition_states(year) 

anim_save(here(paste0("output/mark/natl_counties_total_expenditure.gif")), gif_tot)

```

# Overview Plots

The below plots provide aggregated geographical (national, state, regional) summaries of expenditure categories and shares to demonstrate the composition of national expenditure across the categories. The final two plots demonstrate the composition of expenditure within the Public Welfare, Services & Facilities category.

```{r, warning=FALSE, message = FALSE, cache = TRUE}

# Total as recorded by region
p1 <- tots %>% 
  group_by(year, region) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = region)) +
  geom_area() +
  labs(x = "Year", y = "Expenditure per capita", title = "Total Direct Expenditure per Capita by Region") +
  theme(legend.position = "bottom") + guides(fill=guide_legend(ncol =1))
  

```

```{r, warning=FALSE, message = FALSE, echo = FALSE, fig.height = 8, fig.width = 8, cache = TRUE}

# National Expenditure per category (as calculated from expenditure categories)
p3 <- dfi %>% 
  group_by(year, sum_category) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = sum_category)) +
  geom_area() +
  labs(x = "Year", y = "Expenditure per capita (thousands)", title = "National Expenditure per Category") +
  theme(legend.position = "bottom")

# TOTAL expenditure as calculated from our low-level categories
p4 <- dfi %>% 
  mutate(state = getstate[fips_state],
         region = getregion[state]) %>%
  group_by(year, region) %>% 
  summarise(amount = sum(amount, na.rm = TRUE)) %>% 
  # NOT PER CAPITA VALUES
  ggplot(aes(x = year, y = amount, fill = region)) +
  geom_area() +
  labs(x = "Year", y = "Expenditure (thousands)", title = "National Expenditure per Region (as calculated from expenditure categories)") +
  theme(legend.position = "bottom")



p5a <- temp_dfi %>% 
  group_by(year, broad_cat) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = broad_cat)) +
  geom_area() +
  scale_fill_brewer(name = "Expenditure Category", palette = "Paired") +
  labs(x = "Year", y = "Expenditure per capita (thousands)", title = "National Expenditure per Broad Category") + 
  theme(legend.position = "none", plot.title = element_text(size=10))

p5b <- temp_dfi %>% 
  group_by(year, broad_cat) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount, fill = broad_cat)) +
  geom_area(position="fill", stat="identity") +
  scale_fill_brewer(name = "Expenditure Category", palette = "Paired") +
  labs(x = "Year", y = "Expenditure (share)", title = "National Share of Expenditure per Broad Category") +
  theme(legend.position = "bottom", legend.key.size = unit(0.5, 'cm'), plot.title = element_text(size=10)) + guides(fill=guide_legend(ncol = 2, title.position = "top"))

lev_order <- temp_dfi %>% 
  arrange(broad_cat) %>% 
  mutate(as.factor(sum_category)) %>% 
  pull(sum_category) %>% 
  unique

p5c <- temp_dfi %>% 
  group_by(year, sum_category, broad_cat) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  arrange(broad_cat) %>% 
  mutate(sum_category = factor(sum_category, levels = lev_order)) %>%
  ggplot(aes(x = year, y = amount_pc, fill = sum_category)) +
  geom_area(position="fill", stat="identity") +
  facet_grid(broad_cat~., scales = "free") + 
  scale_fill_viridis(name = "Exp. Cat.", option = "turbo", discrete = TRUE) +
  labs(x = "Year", y = "Share of Expenditure", title = "Composition of Broad National Expenditure Categories") +
  theme(legend.position = "bottom", legend.key.size = unit(0.2, 'cm'), plot.title = element_text(size=9), strip.text.y = element_text(size = 6)) + guides(fill=guide_legend(ncol =2, title.position = "top"))

p6 <- temp_dfi %>% 
  filter(broad_cat == "Public Welfare, Services & Facilities") %>% 
  group_by(year, sum_category, region) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  ggplot(aes(x = year, y = amount, fill = sum_category)) +
  geom_area(position="fill", stat="identity") +
  scale_fill_brewer(name = "Expenditure Category", palette = "Spectral")+
  facet_wrap(~region, scales = "free") +
  labs(x = "Year", y = "Share of expenditure", title = "Share of Total 'Public Welfare, Services & Facilities' Expenditure by Category and Region") +
  theme(legend.position = "bottom", axis.text.y = element_blank())


# Pull top 5 energy producing states (55% of national energy production)
p7 <- temp_dfi %>% 
  filter(state %in% c("TX", "PA", "WY", "OK", "WV", "ND")) %>% 
    filter(broad_cat == "Public Welfare, Services & Facilities") %>% 
  group_by(year, sum_category, state) %>% 
  summarise(amount = sum(amount, na.rm = TRUE),
            population = sum(pop, na.rm = TRUE)) %>% 
  ungroup %>% 
  mutate(amount_pc = amount/population) %>% 
  ggplot(aes(x = year, y = amount_pc, fill = sum_category)) +
  geom_area(position="fill", stat="identity") +
  scale_fill_brewer(name = "Expenditure Category", palette = "Spectral") +
  facet_wrap(~state, scales = "free") +
  labs(x = "Year", y = "Share of expenditure", title = "Share of 'Public Welfare, Services & Facilities' Expenditure by Cat. in Top Energy Producing States") +
  theme(legend.position = "bottom", axis.text.y = element_blank())
    

grid.arrange(grid.arrange(p5a, p5b, nrow = 2), p5c, nrow = 1)
p6
p7


```

```{r, echo = FALSE, message = FALSE, fig.height = 12, cache = TRUE}

broad_cats <- names(select(broad_df, -c(fips, year)))
#broad_df %>% summarise(across(3:10, ~sum(is.na(.x))))
#broad_df_inter %>% summarise(across(3:10, ~sum(is.na(.x))))

vars_static <- c( "Personal Income (PC)" = "pinc_k_pc",
                  "Total Direct Public Expenditure (PC)" = "amount_pc",
                  "Administration & Misc. (PC)" = "administration_misc_pc",
                  "Commercial (PC)" = "commercial_pc",
                  "Infrastructure, Utilities & Regulation (PC)" = "infrastructure_utilities_regulation_pc",
                  "Public Welfare, Services & Facilities (PC)" = "public_welfare_services_facilities_pc")

vals_2017 <- list()
for(k in vars_static){
  vals_2017[[k]] <- broad_df %>% 
  filter(year == 2017) %>% 
    select(fips, pinc_k_pc, administration_misc_pc,commercial_pc,
                  infrastructure_utilities_regulation_pc,
                  public_welfare_services_facilities_pc) %>% 
  left_join(select(filter(tots, year == 2017), fips, amount_pc), by = "fips") %>% 
  pivot_longer(cols = !fips, names_to = "cat", values_to = "value") %>% 
    filter(cat == k) %>% 
    plot_usmap(data = ., values = "value", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Reds", name = "2017 Value", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank(), 
          legend.position = "none") +
    labs(title = names(vars_static[vars_static == k]))
}

do.call(grid.arrange, c(vals_2017, ncol = 2, top = "2017 Values of Key Variables"))
```


# Data Coverage
One of the issues reported by the data collectors is that the surveys are only mandatory every 5 years. So, although data exists and is reported annually, there are several counties that do not report figures in many years. 30% of the panel values are missing due to this. I am unsure what to do with this information and whether there might be any fixes. Climate Econometrics uses indicator saturation to fill in missing values which I would be interested to try but I do not yet know if this is appropriate for this dataset (especially on outcome variables). In the below charts, I have provided a map that shows the proportion of each county's time series (1970-2020) that is missing. States outlined in red are top fossil-fuel producing states (Texas, Pennsylvania, Oklahoma, Wyoming, West Virginia, North Dakota, Nevada, New Mexico, Louisiana, Colorado). 

```{r, message = FALSE, echo = FALSE, warning = FALSE, cache = TRUE}
# Max possible values in each year is : 58102
# n_distinct(temp_dfi$fips) * n_distinct(temp_dfi$sum_category)

# Major conclusion about missing values: only due to non-reporting!
miss_vals <- temp_dfi %>% select(fips, year, sum_category, amount) %>% filter(is.na(amount))
cats <- unique(miss_vals$sum_category)
d.list <- list()
for(ck in cats){
  d.list[[ck]] <- miss_vals %>% filter(sum_category == ck) %>% select(-sum_category)
}
# length(unique(d.list)) == 1

# Histogram of missing values overall: code only works because of above fact
hist_time <- temp_dfi %>% 
  group_by(fips, year) %>% 
  summarise(amount = sum(amount)) %>% 
  ungroup %>% 
  filter(is.na(amount)) %>% 
  ggplot() + 
  geom_histogram(aes(year), bins = 51) +
  geom_hline(aes(yintercept = n_distinct(temp_dfi$fips))) +
  labs(title = "Missing values across full TS", subtitle = "Horizontal line represents total number of counties", y = "Number of counties not reporting", x = "Year")

counties <- temp_dfi %>% 
  group_by(fips, year) %>% 
  summarise(amount = sum(amount)) %>% 
  ungroup %>% 
  group_by(fips) %>% 
  summarise(nna = sum(is.na(amount)),
            prop_missing = nna/51) %>% 
  ungroup %>% 
  plot_usmap(data = ., values = "prop_missing", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Purples", name = "Proportion", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank()) +
    labs(title = paste0("Proportion of TS Missing"))

states <- plot_usmap(include = c("TX", "PA", "OK", "WY", "WV", "ND", "NV", "NM", "LA", "CO"))

missing_spat <- ggplot() +  
  geom_polygon(data=counties[[1]], 
               aes(x=x, 
                   y=y, 
                   group=group, 
                   fill = prop_missing), 
               color = "black",
               size = 0.01) +  
  geom_polygon(data=states[[1]], 
               aes(x=x, 
                   y=y, 
                   group=group), 
               color = "red", 
               fill = alpha(0.01)) + 
  coord_equal() +
  scale_fill_gradient(low='white', high='grey20')+
  labs(y = NULL, x = NULL, title = "Proportion of missing TS by county", subtitle = "Top fossil-fuel producing states outlined in red") +
   theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank(),
      axis.text.x=element_blank(), 
      axis.ticks.x=element_blank(), 
      axis.text.y=element_blank(), 
      axis.ticks.y=element_blank())

grid.arrange(missing_spat, hist_time, ncol = 1)

```


# Analysis of Time Trends
## Panel Linear Time Trends

The following tables provide standard linear time trends evaluated in a county-fixed effects panel linear regression model for a panel of 3,058 counties and for a time period of 1970-2020. \
*Dependent variables*: Expenditure by category per capita values. \
*Data*: Raw data and linearly interpolated data (likely a flawed method).

*Result*: Per capita expenditure does follow an increasing trend albeit very small and not in line with growth in personal income rates (Pinc K below). 

*Note: Amount pc denotes total public expenditure and Pinc K denotes personal income per capita (as GDP indicators are not available for the full duration of the panel).*

```{r, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE}
create_res <- function(df, cats, regx, suffix){
  res <- tibble()
  for(j in cats){
    form <- as.formula(paste0(j, '*1000', regx))
    test <- feols(fml = form, data = df, panel.id = c('year', 'fips'), cluster = "fips")
    test <- test$coeftable %>% as.tibble
    test$outcome_var <- j
    res <- rbind(res, test)
    
  }
  
  tbl <- res %>% 
        mutate(sig = stars.pval(`Pr(>|t|)`),
        outcome_var = str_to_title(gsub("_", " ", gsub(suffix, "", outcome_var)))) %>% 
        relocate(outcome_var) %>% 
        select(-`Pr(>|t|)`) %>% 
        arrange(Estimate) %>% 
    mutate(Estimate = paste0(round(Estimate, 2), sig), `Std. Error` = as.character(round(`Std. Error`, 2))) %>% 
    select(-c(`t value`, sig)) %>% 
    pivot_longer(!outcome_var, values_to = "Estimate", names_to = "_")
    
    return(list("res" = res, "tbl" = tbl))
}


# Time trends: PC expenditure with and without interpolated data
time_broad_raw_pc <- create_res(df = broad_df, cats = broad_cats[grepl("pc", broad_cats)], regx = " ~ time | fips", suffix = "_pc")
time_broad_inter_pc <- create_res(df = broad_df_inter, cats = broad_cats[grepl("pc", broad_cats)], regx = " ~ time | fips", suffix = "_pc")

```


```{r, echo = FALSE, message = FALSE, results = 'asis', warning = FALSE, cache = TRUE}

tk <- full_join(time_broad_raw_pc$tbl, time_broad_inter_pc$tbl, by = c("outcome_var", "_"), suffix = c(".time_raw_pc", ".time_inter_pc")) %>% 
  select(-`_`) %>% 
  group_by(outcome_var) %>%
    mutate(outcome_var = ifelse(duplicated(outcome_var), '', outcome_var)) %>% 
  knitr::kable(., booktabs = TRUE, col.names = c("Outcome Variable", "w. Raw Data", "w. Lin. Interpol."), align = c("l","c","c"), format = "html") %>% 
  add_header_above(c(" ", "Expenditure PC" = 2))

knitr::asis_output(tk)


```


```{r, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE}
# Totals
# Time trends: PC expenditure with and without interpolated data
time_tots_raw_pc <- create_res(df = tots, cats = "amount_pc", regx = " ~ time | fips", suffix = "")
time_tots_inter_pc <- create_res(df = inter_tots, cats = "amount_pc", regx = " ~ time | fips", suffix = "")
```


```{r, echo = FALSE, message = FALSE, results = 'asis', cache = TRUE}
tt <- full_join(time_tots_raw_pc$tbl, time_tots_inter_pc$tbl, 
                by = c("outcome_var", "_"), suffix = c(".time_raw_pc", ".time_inter_pc")) %>%
  select(-`_`) %>%
  group_by(outcome_var) %>%
    mutate(outcome_var = ifelse(duplicated(outcome_var), '', outcome_var)) %>%
  knitr::kable(., booktabs = TRUE, col.names = c("Outcome Variable", "w. Raw Data", "w. Lin. Interpol."), align = c("l","c","c"), format = "html") %>%
  add_header_above(c(" ", "Expenditure (per capita)" = 2))

knitr::asis_output(tt)

```

## Spatial Variation: Linear Time Trends
The below shows spatial distribution of trends in personal income, total direct expenditure, and expenditure (all in per capita values) in our four broad categories (trend values calculated in a linear time series model). These graphs show variation in the linear trends across counties. 
```{r, echo = FALSE, message = FALSE, fig.height = 12, cache = TRUE}

deps = broad_cats[grepl("pc", broad_cats)]
ldeps = paste0(" ~ l(", deps, ")")
forms = paste0(deps, paste0(" ~ l(", deps, ")"))

# Attempt to look at time fixed effect for each expenditure category
# tfe_df <- data.frame()
# for(d in deps[1:4]){
#   f = paste0(d, " ~ l(", d, ") | fips + year")
#   temp = feols(data = broad_df, fml = as.formula(f), panel.id = c('year', 'fips'), se = "twoway")
#   tfe_df <- fixef(temp)$year %>% 
#     data.frame %>% 
#     tibble::rownames_to_column("year") %>% 
#     cbind(cat = d) %>% 
#     rename(., value = `.`) %>%
#     mutate(year = as.numeric(year)) %>% rbind(tfe_df, .)
# }

lin_trends <- broad_df %>% 
  group_by(fips) %>% 
  summarise(admin_misc_trend = unname(coef(lm(administration_misc_pc*1000 ~ time - 1))),
            commercial_trend = unname(coef(lm(commercial_pc*1000 ~ time - 1))),
            infrastructure_utilities_regulation_trend = unname(coef(lm(infrastructure_utilities_regulation_pc*1000 ~ time - 1))),
            public_welfare_services_facilities_trend = unname(coef(lm(public_welfare_services_facilities_pc*1000 ~ time - 1))),
            pinc_k_trend = unname(coef(lm(pinc_k_pc*1000 ~ time - 1)))) %>% 
  left_join(summarise(group_by(tots, fips), total_exp = unname(coef(lm(amount_pc*1000 ~ time - 1)))), by = "fips") %>% 
  pivot_longer(cols = !fips, names_to = "cat", values_to = "trend") %>% 
  mutate(ltrend = log(trend + 1))

tlist <- list()
vars <- c("Personal Income (PC)" = "pinc_k_trend",
          "Total Direct Public Expenditure (PC)" = "total_exp",
          "Administration & Misc. (PC)" = "admin_misc_trend",
          "Commercial (PC)" = "commercial_trend",
          "Infrastructure, Utilities & Regulation (PC)" = "infrastructure_utilities_regulation_trend",
          "Public Welfare, Services & Facilities (PC)" = "public_welfare_services_facilities_trend")


for(k in vars){
  tlist[[k]] <- lin_trends %>% 
    filter(cat == k) %>% 
    plot_usmap(data = ., values = "ltrend", regions = "counties", col = "gray90", linewidth = 0.01, exclude = c("HI", "AK")) + 
    scale_fill_distiller(palette = "Greens", name = "Linear Trend", direction = 1, na.value = "gray90") +
    theme(panel.background = element_rect(color = "white", fill = "white"),
          plot.title = element_text(face = "bold"), legend.background=element_blank(), 
          legend.position = "none") +
    labs(title = names(vars[vars == k]))
}

do.call(grid.arrange, c(tlist, ncol = 2, top = "Linear Trends in Key Variables"))


```



```{r, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE}
deps = paste0(broad_cats[grepl("pc", broad_cats)], "*1000")

# With the county-fixed effects you get an estimate that corrects for unit specific intercepts
time_fe <- feols(data = broad_df, .[deps] ~ time | fips, panel.id = c('year', 'fips'), cluster = "fips")

# AR with county-fixed effects
ar <- feols(data = broad_df, public_welfare_services_facilities_pc*1000 ~ time + l(public_welfare_services_facilities_pc) | fips, panel.id = c('year', 'fips'), cluster = "fips")

ar_twfe <- feols(data = broad_df, public_welfare_services_facilities_pc*1000 ~ l(public_welfare_services_facilities_pc) | fips + year, panel.id = c('year', 'fips'), se = "twoway")
```

# Preliminary Shift-Share Treatment Results            

Preliminary model results making use of shift-share instruments in employment coming from coal, extraction, and oil & gas industries.             

Dependent variables covered (all in per capita values):            
* Total Revenue            
  + Total Revenue (own sources)            
  + Total Taxes            
* Total Public Expenditure            
  + Commercial            
  + Public Welfare, Services, Facilities            
  + Administration & Miscellaneous            
  + Infrastructure, Utilities & Regulation            
  
Model Specifications:            
* First stage regressions using changes in employment in coal, O&G, Extraction            
* 2SLS using employment based shift-share instruments (base years 2001, 2005, and 2011)            
 + 1- and 2-year time lags            
 + interacted with regional dummies (5 in total)            
 + interacted with a dummy for low economic diversity            
* Using total county-level GDP, private-industry level GDP, and govt GDP) together and separately as control variables (govt gdp should be ignored when revenue is a dependent variable).            


All models above were run for the time period 2001-2021 and 2005-2015 (to encompass the years immediately before and after the fossil fuel employment peak in ~2010). This specification was tested mainly as a precaution against static Bartik shares that assume consistency of initial employment shares over the entire time series.             

The models below use a 2SLS approach using the shift-share as an instrument for changes in employment and wages per industry per county. Each model employs county- and year-fixed effects with two-way clustering of the standard errors.            

The following tables show model results where at least one of the treatment variables (ie. not the GDP control variables) have a statistically significant regression coefficient at the 1% level.            

```{r, echo = FALSE, message = FALSE, eval = FALSE, include = FALSE}
## Overall Public Expenditure

# Results transformation function
trans_res <- function(mods){
  return(mods %>% 
  mutate(bartik_base_year = as.numeric(substr(sub('.*ss_emp_coal_|.*ss_wage_coal_|.*ss_emp_oil_gas_|.*ss_wage_oil_gas_|.*ss_emp_extraction_|.*ss_wage_extraction_',"", spec), 1, 4)),
         econ_div_dum = grepl("econ_div", spec),
         region_dum = grepl("region", spec),
         sector = case_when(grepl("2121", spec) ~ "coal",
                           grepl("extraction|21 ", spec) ~ "extraction", 
                           grepl("211", spec) ~ "oil_gas"),
         iv = grepl("year | ", spec, fixed = TRUE)))
  }


control_forms <- c(" ~ gdp_total_pc | fips + year",
                   " ~ gdp_priv_ind_pc | fips + year", 
                   " ~ gdp_priv_ind_pc + gdp_govt_pc | fips + year")
              
                     # Coal
wage_mods <- c(" | fd_total_annual_wages_2121 ~ ss_wage_coal_[y]",
                   " | l(fd_total_annual_wages_2121,1) + l(fd_total_annual_wages_2121,2) ~ l(ss_wage_coal_[y],1) + l(ss_wage_coal_[y],2)",
                   " | i(low_econ_div, fd_total_annual_wages_2121) ~ i(low_econ_div, ss_wage_coal_[y])",
                   " | i(region, fd_total_annual_wages_2121) ~ i(region, ss_wage_coal_[y])",
                     # Extraction                                  
                     " | fd_total_annual_wages_21 ~ ss_wage_extraction_[y]",
                     " | l(fd_total_annual_wages_21,1) + l(fd_total_annual_wages_21,2) ~ l(ss_wage_extraction_[y],1) + l(ss_wage_extraction_[y],2)",
                     " | i(low_econ_div, fd_total_annual_wages_21) ~ i(low_econ_div, ss_wage_extraction_[y])",
                     " | i(region, fd_total_annual_wages_21) ~ i(region, ss_wage_extraction_[y])",
                     # Oil & Gas
                     " | fd_total_annual_wages_211 ~ ss_wage_oil_gas_[y]",
                     " | l(fd_total_annual_wages_211,1) + l(fd_total_annual_wages_211,2) ~ l(ss_wage_oil_gas_[y],1) + l(ss_wage_oil_gas_[y],2)",
                     " | i(low_econ_div, fd_total_annual_wages_211) ~ i(low_econ_div, ss_wage_oil_gas_[y])",
                     " | i(region, fd_total_annual_wages_211) ~ i(region, ss_wage_oil_gas_[y])")

                # Coal
emp_mods <- c(" | fd_annual_avg_emplvl_2121 ~ ss_emp_coal_[y]",
              " | l(fd_annual_avg_emplvl_2121,1) + l(fd_annual_avg_emplvl_2121,2) ~ l(ss_emp_coal_[y],1) + l(ss_emp_coal_[y],2)",
              " | i(low_econ_div, fd_annual_avg_emplvl_2121) ~ i(low_econ_div, ss_emp_coal_[y])",
              " | i(region, fd_annual_avg_emplvl_2121) ~ i(region, ss_emp_coal_[y])",
              
               # Extraction  
               " | fd_annual_avg_emplvl_21 ~ ss_emp_extraction_[y]", 
               " | l(fd_annual_avg_emplvl_21,1) + l(fd_annual_avg_emplvl_21,2) ~ l(ss_emp_extraction_[y],1) + l(ss_emp_extraction_[y],2)",
               " | i(low_econ_div, fd_annual_avg_emplvl_21) ~ i(low_econ_div, ss_emp_extraction_[y])", 
               " | i(region, fd_annual_avg_emplvl_21) ~ i(region, ss_emp_extraction_[y])",
                 
              # Oil & Gas
               " | fd_annual_avg_emplvl_211 ~ ss_emp_oil_gas_[y]",
               " | l(fd_annual_avg_emplvl_211,1) + l(fd_annual_avg_emplvl_211,2) ~ l(ss_emp_oil_gas_[y],1) + l(ss_emp_oil_gas_[y],2)",
               " | i(low_econ_div, fd_annual_avg_emplvl_211) ~ i(low_econ_div, ss_emp_oil_gas_[y])",
               " | i(region, fd_annual_avg_emplvl_211) ~ i(region, ss_emp_oil_gas_[y])")

iv_forms_wage <- list() 
iv_forms_emp <- list()

for(k in c("2001", "2005", "2011")){
  iv_forms_wage <- unlist(append(iv_forms_wage, gsub("[y]", k, wage_mods, fixed = TRUE)))
  iv_forms_emp <- unlist(append(iv_forms_emp, gsub("[y]", k, emp_mods, fixed = TRUE)))
}

# Note that gdp_o_g_mining_quarr_21_pc exists as well! Potential treatment variable?
tot_forms_wage <- c(c(" ~ fd_total_annual_wages_2121 + gdp_total_pc | fips + year",
                      " ~ fd_total_annual_wages_21 + gdp_total_pc | fips + year",
                      " ~ fd_total_annual_wages_211 + gdp_total_pc | fips + year",
                      " ~ fd_total_annual_wages_2121 + gdp_priv_ind_pc + gdp_govt_pc | fips + year",
                      " ~ fd_total_annual_wages_21 + gdp_priv_ind_pc + gdp_govt_pc | fips + year",
                      " ~ fd_total_annual_wages_211 + gdp_priv_ind_pc + gdp_govt_pc | fips + year",
                      " ~ fd_total_annual_wages_2121 + gdp_priv_ind_pc | fips + year",
                      " ~ fd_total_annual_wages_21 + gdp_priv_ind_pc | fips + year",
                      " ~ fd_total_annual_wages_211 + gdp_priv_ind_pc | fips + year"),
                    paste0(sort(rep(control_forms, length(iv_forms_wage))), iv_forms_wage))

tot_forms_emp <- c(c(" ~ fd_annual_avg_emplvl_2121 + gdp_total_pc | fips + year", 
                     " ~ fd_annual_avg_emplvl_21 + gdp_total_pc | fips + year",
                     " ~ fd_annual_avg_emplvl_211 + gdp_total_pc | fips + year",
                     " ~ fd_annual_avg_emplvl_2121 + gdp_priv_ind_pc + gdp_govt_pc | fips + year", 
                     " ~ fd_annual_avg_emplvl_21 + gdp_priv_ind_pc + gdp_govt_pc | fips + year",
                     " ~ fd_annual_avg_emplvl_211 + gdp_priv_ind_pc + gdp_govt_pc | fips + year", 
                   " ~ fd_annual_avg_emplvl_2121 + gdp_priv_ind_pc | fips + year", 
                     " ~ fd_annual_avg_emplvl_21 + gdp_priv_ind_pc | fips + year",
                     " ~ fd_annual_avg_emplvl_211 + gdp_priv_ind_pc | fips + year"), 
                   paste0(sort(rep(control_forms, length(iv_forms_emp))), iv_forms_emp))

tot_forms_emp_rest <- tot_forms_emp[!grepl("2001|2011", tot_forms_emp)]
tot_forms_wage_rest <- tot_forms_wage[!grepl("2001|2011", tot_forms_wage)]

mods_pub_exp_total <- tibble()
for(form in c(tot_forms_emp, tot_forms_wage)){
    forms <- paste0("amount_pc*1000", form)
    w_e <- ifelse(grepl("wage", form), "wage", "emp")
    res_curr <- feols(data = tots_df_ss, as.formula(forms), panel.id = c('year', 'fips'), se = "twoway")
    sfig <- sum(pvalue(res_curr)[which(!grepl("gdp", names(pvalue(res_curr))))] < 0.01) > 0
    mods_pub_exp_total <- rbind(mods_pub_exp_total,
                                    tibble(spec = forms,
                                           wage_emp = w_e,
                                           dep_var = "total",
                                           sig01 = sfig,
                    res = list(res_curr)))
}

mods_pub_exp_total_rest <- tibble()
for(form in c(tot_forms_emp_rest, tot_forms_wage_rest)){
    forms <- paste0("amount_pc*1000", form)
    w_e <- ifelse(grepl("wage", form), "wage", "emp")
    res_curr <- feols(data = filter(tots_df_ss, year >= 2005 & year <= 2015), as.formula(forms), panel.id = c('year', 'fips'), se = "twoway")
    sfig <- sum(pvalue(res_curr)[which(!grepl("gdp", names(pvalue(res_curr))))] < 0.01) > 0
    mods_pub_exp_total_rest <- rbind(mods_pub_exp_total_rest,
                                    tibble(spec = forms,
                                           wage_emp = w_e,
                                           dep_var = "total",
                                           sig01 = sfig,
                    res = list(res_curr)))
}

mods_pub_exp_total %>% trans_res %>% saveRDS(here("output/results_mods_pub_exp_total.RDS"))
mods_pub_exp_total_rest %>% trans_res %>% saveRDS(here("output/results_mods_pub_exp_total_rest.RDS"))


# print("TOTAL PUBLIC EXPENDITURE (PC): EMP")
# for(i in 1:nrow(filter(mods_pub_exp_total, sig01 & wage_emp == "emp"))){
#   mods_pub_exp_total %>% filter(sig01 & wage_emp == "emp") %>% slice(i) %>% pull(spec) %>% print
#   mods_pub_exp_total %>% filter(sig01 & wage_emp == "emp") %>% slice(i) %>% pull(res) %>% first %>% print
# }
# 
# print("TOTAL PUBLIC EXPENDITURE (PC): WAGE")
# for(i in 1:nrow(filter(mods_pub_exp_total, sig01 & wage_emp == "wage"))){
#   mods_pub_exp_total %>% filter(sig01 & wage_emp == "wage") %>%slice(i) %>% pull(spec) %>% print
#   mods_pub_exp_total %>% filter(sig01 & wage_emp == "wage") %>%slice(i) %>% pull(res) %>% first %>% print
# }


```



```{r, echo = FALSE, message = FALSE, eval = FALSE, include = FALSE}
## Granular Categories

deps = c("ADMINISTRATION & MISC EXPENDITURE (PC)" = "administration_misc_pc",
         "COMMERCIAL EXPENDITURE (PC)" = "commercial_pc",
         "INFRASTRUCTURE, UTILITIES & REGULATION (PC)" = "infrastructure_utilities_regulation_pc",
         "PUBLIC WELFARE, SERVICES & FACILITIES (PC)" = "public_welfare_services_facilities_pc")


mods_gran_exp <- tibble()
for(dep in deps){
  for(form in c(tot_forms_emp, tot_forms_wage)){
    forms <- paste0(dep, "*1000", form)
    w_e <- ifelse(grepl("wage", form), "wage", "emp")
    res_curr <- feols(data = broad_df_ss, as.formula(forms), panel.id = c('year', 'fips'), se = "twoway")
    sfig <- sum(pvalue(res_curr)[which(!grepl("gdp", names(pvalue(res_curr))))] < 0.01) > 0
    mods_gran_exp <- rbind(mods_gran_exp, 
                                    tibble(spec = forms, 
                                            wage_emp = w_e,
                                           dep_var = dep,
                                           sig01 = sfig,
                    res = list(res_curr)))
  }
}

mods_gran_exp_rest <- tibble()
for(dep in deps){
for(form in c(tot_forms_emp_rest, tot_forms_wage_rest)){
    forms <- paste0(dep, "*1000", form)
    w_e <- ifelse(grepl("wage", form), "wage", "emp")
    res_curr <- feols(data = filter(broad_df_ss, year >= 2005 & year <= 2015), as.formula(forms), panel.id = c('year', 'fips'), se = "twoway")
    sfig <- sum(pvalue(res_curr)[which(!grepl("gdp", names(pvalue(res_curr))))] < 0.01) > 0
    mods_gran_exp_rest <- rbind(mods_gran_exp_rest, 
                                    tibble(spec = forms, 
                                            wage_emp = w_e,
                                           dep_var = dep,
                                           sig01 = sfig,
                    res = list(res_curr)))
  }
}


mods_gran_exp %>% trans_res %>% saveRDS(here("output/results_mods_gran_exp.RDS"))
mods_gran_exp_rest %>% trans_res %>% saveRDS(here("output/results_mods_gran_exp_rest.RDS"))


# for(i in deps){
#   print(names(deps[deps == i]))
#   for(we in c("emp", "wage")){
#     temp <- mods_gran_exp %>% filter(wage_emp == we & dep_var == i & sig01)
#     for(k in 1:nrow(temp)){
#       temp %>% slice(k) %>% pull(spec) %>% print
#       temp %>% slice(k) %>% pull(res) %>% first %>% print
#     }
#   }
# }

```


```{r, echo = FALSE, message = FALSE, eval = FALSE, include = FALSE}
## Overall Public Revenue

deps = c("TOTAL REVENUE (PC)" = "total_revenue_pc",
         "TOTAL REVENUE OWN SOURCES (PC)" = "total_rev_own_sources_pc",
         # "TOTAL UTILITY REVENUE (PC)" = "total_utility_revenue_pc",
         #"TOTAL UNEMPLOYMENT REVENUE (PC)" = "total_unemp_rev",
         #"TOTAL UNEMPLOYMENT FEDERAL ADVANCES (PC)" = "unemp_federal_advances",
         "TOTAL TAXES (PC)" = "total_taxes_pc")
         #"CORPORATE NET INCOME TAX (PC)" = "corp_net_income_tax_pc")


mods_pub_rev <- tibble()
for(dep in deps){
  #for(df in list(inter_rev, rev_df)){
   # ilog = ifelse(df == inter_rev, TRUE, FALSE)
    for(form in c(tot_forms_wage, tot_forms_emp)){
      forms <- paste0(dep, "*1000", form)
      w_e <- ifelse(grepl("wage", form), "wage", "emp")
      res_curr <- feols(data = inter_rev, as.formula(forms), panel.id = c('year', 'fips'), se = "twoway")
      sfig <- sum(pvalue(res_curr)[which(!grepl("gdp", names(pvalue(res_curr))))] < 0.01) > 0
      mods_pub_rev <- rbind(mods_pub_rev, 
                                      tibble(spec = forms, 
                                              wage_emp = w_e,
                                             dep_var = dep,
                                             inter = TRUE, #ilog,
                                             sig01 = sfig,
                      res = list(res_curr)))
    #}
  }
}

mods_pub_rev_rest <- tibble()
for(dep in deps){
  #for(df in list(inter_rev, rev_df)){
   # ilog = ifelse(df == inter_rev, TRUE, FALSE)
    for(form in c(tot_forms_emp_rest, tot_forms_wage_rest)){
      forms <- paste0(dep, "*1000", form)
      w_e <- ifelse(grepl("wage", form), "wage", "emp")
      res_curr <- feols(data = filter(inter_rev, year >= 2005 & year <= 2015), as.formula(forms), panel.id = c('year', 'fips'), se = "twoway")
      sfig <- sum(pvalue(res_curr)[which(!grepl("gdp", names(pvalue(res_curr))))] < 0.01) > 0
      mods_pub_rev_rest <- rbind(mods_pub_rev_rest, 
                                      tibble(spec = forms, 
                                              wage_emp = w_e,
                                             dep_var = dep,
                                             inter = TRUE, #ilog,
                                             sig01 = sfig,
                      res = list(res_curr)))
    #}
  }
}

mods_pub_rev %>% trans_res %>% saveRDS(here("output/results_mods_pub_rev.RDS"))
mods_pub_rev_rest %>% trans_res %>% saveRDS(here("output/results_mods_pub_rev_rest.RDS"))


```

## Results by Industry Type and Dependent Variable {.tabset}

```{r, echo = FALSE, results = 'asis', fig.height = 9}


dict = c(pinc_k_pc = "Personal Income (pc_k)",
         fd_total_annual_wages_2121 = "Wage Coal (FD)",
         fd_total_annual_wages_21 = "Wage Extract. (FD)",
         fd_total_annual_wages_211 = "Wage O&G (FD)",
         fd_annual_avg_emplvl_2121 = "Emp. Coal (FD)",
         fd_annual_avg_emplvl_21 = "Emp. Extract. (FD)", 
         fd_annual_avg_emplvl_211 = "Emp. O&G (FD)",
         "administration_misc_pc*1000" = "Admin&Misc",
         "commercial_pc*1000 "= "Commercial",
         "infrastructure_utilities_regulation_pc*1000" = "Infr,Util,Reg",
         "public_welfare_services_facilities_pc*1000" = "Welf,Serv,Facil",
         amount_pc = "Tot. Pub. Exp (PC)",
         gdp_total_pc = "Total GDP (PC)",
         gdp_priv_ind_pc = "GDP Priv. Ind. (PC)",
         gdp_govt_pc = "Govt GDP (PC)",
         "fit_l(fd_annual_avg_emplvl_2121, 2)" = "Coal Emp Brtk (l2)",
         "fit_l(fd_annual_avg_emplvl_2121, 1)" = "Coal Emp Brtk (l1)",
         "fit_region::Northeast:fd_annual_avg_emplvl_2121" = "Region_{NE}xEmp. Coal (FD)",
         "fit_region::South:fd_annual_avg_emplvl_2121" = "Region_{S}xEmp. Coal (FD)",
         "fit_region::North Central:fd_annual_avg_emplvl_2121" = "Region_{NC}xEmp. Coal (FD)",
         "fit_region::West:fd_annual_avg_emplvl_2121" = "Region_{W}xEmp. Coal (FD)",
         "fit_low_econ_div::0:fd_annual_avg_emplvl_2121" = "EconDiv_{low}xEmp. Coal (FD)",
         "fit_low_econ_div::1:fd_annual_avg_emplvl_2121" = "EconDiv_{high}xEmp. Coal (FD)",
         "fit_l(fd_annual_avg_emplvl_211, 2)" = "O&G Emp Brtk (l2)",
         "fit_l(fd_annual_avg_emplvl_211, 1)" = "O&G Emp Brtk (l1)",
         "fit_region::Northeast:fd_annual_avg_emplvl_211" = "Region_{NE}xEmp. O&G (FD)",
         "fit_region::South:fd_annual_avg_emplvl_211" = "Region_{S}xEmp. O&G (FD)",
         "fit_region::North Central:fd_annual_avg_emplvl_211" = "Region_{NC}xEmp. O&G (FD)",
         "fit_region::West:fd_annual_avg_emplvl_211" = "Region_{W}xEmp. O&G (FD)",
         "fit_low_econ_div::0:fd_annual_avg_emplvl_211" = "EconDiv_{low}xEmp. O&G (FD)",
         "fit_low_econ_div::1:fd_annual_avg_emplvl_211" = "EconDiv_{high}xEmp. O&G (FD)",
          "fit_l(fd_annual_avg_emplvl_21, 2)" = "Extr. Emp Brtk (l2)",
         "fit_l(fd_annual_avg_emplvl_21, 1)" = "Extr. Emp Brtk (l1)",
         "fit_region::Northeast:fd_annual_avg_emplvl_21" = "Region_{NE}xEmp. Extr. (FD)",
         "fit_region::South:fd_annual_avg_emplvl_21" = "Region_{S}xEmp. Extr. (FD)",
         "fit_region::North Central:fd_annual_avg_emplvl_21" = "Region_{NC}xEmp. Extr. (FD)",
         "fit_region::West:fd_annual_avg_emplvl_21" = "Region_{W}xEmp. Extr. (FD)",
         "fit_low_econ_div::0:fd_annual_avg_emplvl_21" = "EconDiv_{low}xEmp. Extr. (FD)",
         "fit_low_econ_div::1:fd_annual_avg_emplvl_21" = "EconDiv_{high}xEmp. Extr. (FD)"
         )

setFixest_dict(dict)
#setFixest_etable(markdown = TRUE)

mods_pub_exp_total <- readRDS(here("output/results_mods_pub_exp_total.RDS"))
mods_pub_exp_total_rest <- readRDS(here("output/results_mods_pub_exp_total_rest.RDS"))
mods_gran_exp <- readRDS(here("output/results_mods_gran_exp.RDS"))
mods_gran_exp_rest <- readRDS(here("output/results_mods_gran_exp_rest.RDS"))
mods_pub_rev <- readRDS(here("output/results_mods_pub_rev.RDS"))
mods_pub_rev_rest <- readRDS(here("output/results_mods_pub_rev_rest.RDS"))


ind_types <- list("Coal" = "coal",
                  "Oil & Gas" = "oil_gas",
                  "Extraction" = "Extraction")

dep_dfs <- list("Public Revenue" = mods_pub_rev,
                "Public Expenditure (Total)" = mods_pub_exp_total,
                "Public Expenditure (Granular)" = mods_gran_exp)



for(i in ind_types){
  cat('### ', names(ind_types[ind_types == i]), '{.tabset}   \n')
    for(d in names(dep_dfs)){
      cat('#### ', d, '{.tabset}   \n')
      tmp <- dep_dfs[which(names(dep_dfs) == d)] %>% first %>% filter(sig01 & wage_emp == "emp", sector == i)
      cat('\n')
      cat('\n')
      cat('\n')
      if(nrow(tmp) != 0){
        deps <- tmp %>% pull(dep_var) %>% unique
        for(dep in deps){
          cat('##### ', toupper(dep), '{.tabset}   \n')
            tmp %>% filter(dep_var == dep) %>% pull(res) %>% modelsummary(stars = TRUE, coef_rename = dict) %>% print
           cat('\n')
            cat('\n')
            cat('\n')
          }}else{print("No significant results!")}
        cat('\n')
        cat('\n')
        cat('\n')
      }
    cat('\n')
    cat('\n')
    cat('\n')
}  





```

## Results for restricted time series {.tabset}

The following shows the significant results (using same exclusion restrictions and mdoel specifications as in the above section - 1% statistically significant regressors excluding GDP controls) but restricts the time series to 2005-2015 to encompass the years immediately before and after the fossil fuel employment peak in ~2010. This specification was tested mainly as a precaution against static Bartik shares that assume consistency of initial employment shares over the entire time series. 


```{r, echo = FALSE, results = 'asis', fig.height = 9}

dep_dfs <- list("Public Revenue" = mods_pub_rev_rest,
                "Public Expenditure (Total)" = mods_pub_exp_total_rest,
                "Public Expenditure (Granular)" = mods_gran_exp_rest)


for(i in ind_types){
  cat('### ', names(ind_types[ind_types == i]), '{.tabset}   \n')
  cat('\n')
      cat('\n')
      cat('\n')
    for(d in names(dep_dfs)){
      cat('#### ', d, '{.tabset}   \n')
      tmp <- dep_dfs[which(names(dep_dfs) == d)] %>% first %>% filter(sig01 & wage_emp == "emp" & sector == i)
      cat('\n')
      cat('\n')
      cat('\n')
      if(nrow(tmp) != 0){
      deps <- tmp %>% pull(dep_var) %>% unique
      for(dep in deps){
         cat('##### ', toupper(dep), '{.tabset}   \n')
         tmp %>% filter(dep_var == dep) %>% pull(res) %>% modelsummary(stars = TRUE, coef_rename = dict) %>% print
          cat('\n')
          cat('\n')
          cat('\n')
      }}else{print("No significant results!")}
    cat('\n')
    cat('\n')
    cat('\n')
    } 
    cat('\n')
    cat('\n')
    cat('\n')
  }



```



```{r, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE, include = FALSE, eval = FALSE}

# Time heterogeneity (work in progress)
Shows distribution of expenditure per capita values across counties over time. The green line denotes the annual mean value, blue line denotes the top quartile, and red line denotes the bottom quartile. 


broad_df_inter_long <- broad_df_inter %>% 
  select(fips, year, administration_misc_pc, 
         commercial_pc, infrastructure_utilities_regulation_pc, 
         public_welfare_services_facilities_pc) %>% 
  pivot_longer(cols = !c(fips, year))

deps = broad_cats[grepl("pc", broad_cats)]
plist <- list()
for(k in deps[1:4]){
  plist[[k]] = broad_df_inter_long %>%
  filter(name == k) %>%
  group_by(year) %>%
  summarise(mean = mean(value*1000, na.rm = TRUE),
            upp_quart = quantile(value*1000, probs = c(0.75), na.rm = TRUE),
            low_quart = quantile(value*1000, probs = c(0.25), na.rm = TRUE)) %>%
  left_join(broad_df_inter_long) %>%
  ggplot(data = .,
         aes(x = year, y = value*1000)) +
  geom_point() +
  geom_line(aes(x = year, y = mean), col = "green") +
  geom_line(aes(x = year, y = upp_quart), col = "blue") +
  geom_line(aes(x = year, y = low_quart), col = "red") +
  scale_x_continuous(labels = as.character(broad_df_inter_long$year),
                     breaks = broad_df_inter_long$year) +
  labs(x = "Year", y = k) +
  theme(axis.text.x = element_text(angle = 90))
}

do.call(grid.arrange, c(plist, ncol = 2))



```



```{r, include = FALSE, eval = FALSE}

## NEXT...
### Factor Analysis

### Spatial Analysis

# Sample code from coal paper
library(gstat)
# Using coordinate data
county_coord <- read.csv(here("data/us-county-boundaries.csv"), sep = ";") %>% select(GEOID, INTPTLAT, INTPTLON) %>% tibble %>% mutate(GEOID = ifelse(nchar(GEOID) == 4, paste0("0", as.character(GEOID)), as.character(GEOID))) %>% rename(fips = GEOID) %>% filter(fips %in% allcomp_full$fips) %>% right_join(select(allcomp_full, year, diff_uer, fips), by = "fips") %>% filter(!is.na(INTPTLAT))
                         
#coordinates(county_coord) = ~INTPTLON+INTPTLAT
spat_dep <- tibble(year = character(),
                   gamma = numeric(),
                   dist = numeric())
for(i in 2002:2019){
  t <- filter(county_coord, year == i)
  coordinates(t) = ~INTPTLON+INTPTLAT
  test <- variogram(diff_uer ~ 1, locations = coordinates(t), data = t, cutoff = 10)
  spat_dep <- rbind(spat_dep, tibble(year = i,
                                     gamma = test$gamma,
                                     dist = test$dist))
}

library(ggrepel)
full_spat <- spat_dep %>% mutate(year = as.factor(year)) %>% group_by(year) %>% mutate(label = ifelse(dist == max(dist), as.character(year), NA)) %>% 
ggplot(aes(x = dist, y = gamma, color = year, group = year)) +
  geom_line() +
  geom_label_repel(aes(label = label),
                   nudge_x = 2,
                   na.rm = TRUE,
                   max.overlaps = Inf) +
  theme(legend.position = "none", panel.background = element_blank(), panel.grid.major = element_line(colour = "grey90", linetype = "dashed")) +
  xlab("Distance between counties") +
  ylab("Measure of dissimilarity of outcome variable (UER)")

```




